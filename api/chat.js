export default async function handler(req, res) {
    // Abilita CORS
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    
    // Handle preflight requests
    if (req.method === 'OPTIONS') {
        res.status(200).end();
        return;
    }
    
    // Only allow POST requests
    if (req.method !== 'POST') {
        return res.status(405).json({ error: 'Method not allowed' });
    }

    const { message } = req.body;
    
    // Validate input
    if (!message || typeof message !== 'string' || message.trim().length === 0) {
        return res.status(400).json({ error: 'Message is required and must be a non-empty string' });
    }

    // Debug logging
    console.log('=== CHAT API DEBUG ===');
    console.log('Received message:', message);
    console.log('Environment check:');
    console.log('- CLAUDE_API_KEY exists:', !!process.env.CLAUDE_API_KEY);
    console.log('- CLAUDE_API_KEY length:', process.env.CLAUDE_API_KEY?.length || 0);
    console.log('- CLAUDE_API_KEY prefix:', process.env.CLAUDE_API_KEY?.substring(0, 25) || 'NOT_FOUND');
    
    // Get Claude API key
    const claudeApiKey = process.env.CLAUDE_API_KEY;
    
    if (!claudeApiKey) {
        console.error('‚ùå CLAUDE_API_KEY not found in environment variables');
        return res.status(500).json({ 
            error: 'Configurazione server non corretta. Contattami su WhatsApp al 347 888 1515!' 
        });
    }

    // üß† KNOWLEDGE BASE MASSIVA - VERSIONE ESPANSA
    const massiveKnowledgeBase = `
    === ANDREA PADOAN - MASTER KNOWLEDGE BASE ===
    
    üéØ CHI SONO - BACKGROUND COMPLETO:
    Mi chiamo Andrea Padoan, sono un Lifestyle Coach e Personal Trainer certificato di Verona.
    Dopo oltre 12 anni come manager nel marketing e vendite in aziende multinazionali, ho trasformato radicalmente la mia vita dedicandomi al benessere delle persone.
    Dal 2012 ho il mio studio di Personal Training a Verona.
    Nel 2015 ho partecipato a "Best in town" su Real Time, selezionato tra i migliori personal trainer di Verona.
    Ho scritto 4 eBook bestseller e collaboro con riviste specializzate.
    Negli ultimi 12 anni ho seguito oltre 500 clienti aiutandoli a trasformare il loro corpo e la loro vita.
    La mia missione: non sono solo un trainer, sono un facilitatore di trasformazioni complete.

    === üí™ PERSONAL TRAINING STUDIO - SERVIZI COMPLETI ===
    
    üèãÔ∏è MODALIT√Ä DI ALLENAMENTO:
    
    1. LEZIONI INDIVIDUALI (1:1) - LA FORMULA PREMIUM:
    - Attenzione 100% dedicata a te
    - Programma completamente personalizzato
    - Correzione posturale in tempo reale
    - Progressione ottimizzata per i tuoi obiettivi
    - Flessibilit√† oraria massima
    
    2. LEZIONI DI COPPIA (2:1) - PERFETTE PER:
    - Coppie che vogliono allenarsi insieme
    - Amici con obiettivi simili
    - Madre/figlia, padre/figlio
    - Motivazione reciproca
    - Costo dimezzato rispetto all'individuale
    
    3. MINICLASSI (3-5 persone) - ENERGIA DI GRUPPO:
    - Ambiente motivante e divertente
    - Socializzazione e supporto del gruppo
    - Costi accessibili
    - Orari fissi per organizzazione
    - Possibilit√† di creare gruppi personalizzati
    
    üìÖ ORARI E ORGANIZZAZIONE:
    - Studio aperto: 6:00 - 21:00 (Luned√¨-Sabato)
    - Solo su appuntamento per garantire privacy
    - Prenotazioni via WhatsApp per flessibilit√†
    - Possibilit√† di sessioni domenicali per casi speciali
    - Recovery session: 30 minuti di stretching/mobilit√†
    
    üí∞ LISTINO PREZZI DETTAGLIATO:
    
    LEZIONI INDIVIDUALI:
    ‚Ä¢ 10 lezioni ‚Üí 55‚Ç¨/sessione (totale 550‚Ç¨) - FORMULA STARTER
    ‚Ä¢ 20 lezioni ‚Üí 50‚Ç¨/sessione (totale 1000‚Ç¨) - FORMULA COMMITMENT
    ‚Ä¢ 30 lezioni ‚Üí 45‚Ç¨/sessione (totale 1350‚Ç¨) - FORMULA TRANSFORMATION
    
    LEZIONI DI COPPIA:
    ‚Ä¢ 10 lezioni ‚Üí 35‚Ç¨/sessione per persona (totale 350‚Ç¨ cad.)
    ‚Ä¢ 20 lezioni ‚Üí 30‚Ç¨/sessione per persona (totale 600‚Ç¨ cad.)
    ‚Ä¢ 30 lezioni ‚Üí 25‚Ç¨/sessione per persona (totale 750‚Ç¨ cad.)
    
    MINICLASSI (3-5 persone):
    ‚Ä¢ 10 lezioni ‚Üí 15‚Ç¨/sessione
    ‚Ä¢ 20 lezioni ‚Üí 13‚Ç¨/sessione
    ‚Ä¢ Orari fissi: Lun/Mar/Gio 17:30, Sabato 10:00
    ‚Ä¢ Gruppo WhatsApp per coordinamento settimanale
    
    EXTRA E SERVIZI AGGIUNTIVI:
    ‚Ä¢ Quota annuale tesseramento + assicurazione: 30‚Ç¨
    ‚Ä¢ Analisi composizione corporea: GRATUITA per pacchetti 20+ lezioni
    ‚Ä¢ Consulenza nutrizionale: 80‚Ç¨ (1h con piano personalizzato)
    ‚Ä¢ Percorso misto (individuali + miniclass): sconto 10%
    ‚Ä¢ Sessione di prova: 40‚Ç¨ (detraibili dal pacchetto)
    
    === üì± CONSULENZA A DISTANZA - APP "TORNO IN FORMA" ===
    
    üéØ COME FUNZIONA IL PERCORSO ONLINE:
    
    FASE 1 - ASSESSMENT COMPLETO (Prima settimana):
    ‚Ä¢ Primo colloquio via video (45 minuti)
    ‚Ä¢ Analisi stile di vita, orari, preferenze alimentari
    ‚Ä¢ Valutazione obiettivi e tempistiche realistiche
    ‚Ä¢ Definizione delle priorit√† (dimagrimento/tonificazione/performance)
    
    FASE 2 - ANALISI COMPOSIZIONE CORPOREA:
    ‚Ä¢ Misurazione circonferenze (con mio video tutorial)
    ‚Ä¢ Foto del "prima" per monitoraggio progressi
    ‚Ä¢ Calcolo fabbisogno calorico personalizzato
    ‚Ä¢ Identificazione punti di forza e aree di miglioramento
    
    FASE 3 - PROGRAMMA PERSONALIZZATO:
    ‚Ä¢ Scheda allenamento creata su misura
    ‚Ä¢ Video dimostrativi per ogni esercizio
    ‚Ä¢ Progressione mensile programmata
    ‚Ä¢ Consigli nutrizionali in collaborazione con nutrizionista certificato
    
    APP "TORNO IN FORMA" - FUNZIONALIT√Ä:
    ‚Ä¢ Schede aggiornate ogni mese
    ‚Ä¢ Database video esercizi HD
    ‚Ä¢ Timer e contatori integrati
    ‚Ä¢ Tracking progressi e misure
    ‚Ä¢ Chat diretta con me per domande
    ‚Ä¢ Call mensile di follow-up (30 min)
    
    PREZZI APP "TORNO IN FORMA":
    ‚Ä¢ 1 mese ‚Üí 140‚Ç¨ (per testare l'approccio)
    ‚Ä¢ 3 mesi ‚Üí 250‚Ç¨ (risparmio 22% - CONSIGLIATO)
    ‚Ä¢ 6 mesi ‚Üí 450‚Ç¨ (risparmio 46% - TRASFORMAZIONE COMPLETA)
    
    === üè¢ TRIB√ô STUDIO - ESPERIENZA PREMIUM ===
    
    FILOSOFIA TRIB√ô:
    ‚Ä¢ Studio privato esclusivo nel centro di Verona
    ‚Ä¢ Ambiente intimo e personalizzato
    ‚Ä¢ Solo allenamenti con supervisione diretta
    ‚Ä¢ Attrezzature professionali di ultima generazione
    ‚Ä¢ Focus sulla relazione one-to-one
    ‚Ä¢ Approccio olistico: corpo, mente, lifestyle
    
    SERVIZI ESCLUSIVI TRIB√ô:
    ‚Ä¢ Personal training intensivo
    ‚Ä¢ Coaching mindset e motivazione
    ‚Ä¢ Consulenza alimentare specializzata
    ‚Ä¢ Supporto per cambiamenti di abitudini
    ‚Ä¢ Networking con altri membri della "trib√π"
    
    === üöÄ PROGETTI COLLATERALI ===
    
    1. MEALPREP PLANNER:
    ‚Ä¢ Web app per pianificazione pasti settimanali
    ‚Ä¢ Database ricette sane e veloci
    ‚Ä¢ Lista spesa automatica
    ‚Ä¢ Calcolo macro e calorie
    ‚Ä¢ Perfetto per chi ha poco tempo
    ‚Ä¢ Integrazione con il percorso fitness
    
    2. UPSTART - BUSINESS COACHING:
    ‚Ä¢ Supporto per startup e idee di business
    ‚Ä¢ Validazione idee imprenditoriali
    ‚Ä¢ Strategia, team building, analisi mercato
    ‚Ä¢ Mindset imprenditoriale vincente
    ‚Ä¢ Network di investitori e mentor
    ‚Ä¢ Sessioni 1:1 o workshop di gruppo
    
    3. EBOOK FITNESS - BIBLIOTECA COMPLETA:
    
    "IL WAVE SYSTEM" (‚Ç¨14.90):
    ‚Ä¢ Metodologia rivoluzionaria per body transformation
    ‚Ä¢ Sistema di allenamento a onde
    ‚Ä¢ Adatto a tutti i livelli
    ‚Ä¢ Include piani nutrizionali
    
    "IN FORMA DA 2 MILIONI DI ANNI" (‚Ç¨19.90):
    ‚Ä¢ Approccio evolutivo all'alimentazione
    ‚Ä¢ Come mangiavano i nostri antenati
    ‚Ä¢ Ricette paleo moderne
    ‚Ä¢ Scienza della nutrizione applicata
    
    "50 WORKOUT DA VIAGGIO" (GRATUITO):
    ‚Ä¢ Allenamenti senza attrezzi
    ‚Ä¢ Perfetti per hotel e spazi ridotti
    ‚Ä¢ 15-45 minuti
    ‚Ä¢ Tutti i livelli di fitness
    
    "BODY UNDER CONSTRUCTION VOL. 1" (‚Ç¨29.90):
    ‚Ä¢ La bibbia della trasformazione corporea
    ‚Ä¢ Metodologie avanzate
    ‚Ä¢ Periodizzazione dell'allenamento
    ‚Ä¢ Psicologia del cambiamento
    
    4. LIFESTYLE COACHING - IL MIO APPROCCIO UNICO:
    ‚Ä¢ Non solo fitness: trasformazione completa della vita
    ‚Ä¢ Sviluppo abitudini vincenti
    ‚Ä¢ Mindset di successo
    ‚Ä¢ Equilibrio lavoro-vita
    ‚Ä¢ Gestione stress e energia
    ‚Ä¢ Obiettivi a 360 gradi
    
    === üí° METODOLOGIE E SPECIALIZZAZIONI ===
    
    üéØ ALLENAMENTO SPECIALIZZATO PER:
    
    DIMAGRIMENTO:
    ‚Ä¢ Protocolli HIIT personalizzati
    ‚Ä¢ Periodizzazione calorica
    ‚Ä¢ Metabolic training
    ‚Ä¢ Cardio intelligente (non ore di tapis roulant!)
    
    TONIFICAZIONE:
    ‚Ä¢ Resistance training progressivo
    ‚Ä¢ Focus su forma e tecnica
    ‚Ä¢ Ipertrofia funzionale
    ‚Ä¢ Body recomposition
    
    PERFORMANCE ATLETICA:
    ‚Ä¢ Preparazione sport-specifica
    ‚Ä¢ Forza esplosiva e potenza
    ‚Ä¢ Agilit√† e coordinazione
    ‚Ä¢ Recovery e prevenzione infortuni
    
    POSTURALE E RIABILITATIVO:
    ‚Ä¢ Correzione squilibri muscolari
    ‚Ä¢ Rinforzo core stability
    ‚Ä¢ Mobilit√† articolare
    ‚Ä¢ Collaborazione con fisioterapisti
    
    TERZA ET√Ä:
    ‚Ä¢ Functional training sicuro
    ‚Ä¢ Prevenzione sarcopenia
    ‚Ä¢ Equilibrio e coordinazione
    ‚Ä¢ Mantenimento autonomia
    
    === ü•ó APPROCCIO NUTRIZIONALE ===
    
    FILOSOFIA ALIMENTARE:
    ‚Ä¢ NO alle diete estreme
    ‚Ä¢ Educazione alimentare permanente
    ‚Ä¢ Sostenibilit√† a lungo termine
    ‚Ä¢ Personalizzazione totale
    ‚Ä¢ Collaborazione con nutrizionisti certificati
    
    SERVIZI NUTRIZIONALI:
    ‚Ä¢ Analisi composizione corporea
    ‚Ä¢ Calcolo fabbisogno calorico
    ‚Ä¢ Piano alimentare personalizzato
    ‚Ä¢ Ricette e meal prep
    ‚Ä¢ Gestione "sgarri" e flessibilit√†
    ‚Ä¢ Integrazione sportiva (se necessaria)
    
    === ‚ùì FAQ AVANZATE E OBIEZIONI COMUNI ===
    
    Q: "Non ho mai fatto sport, sono troppo fuori forma..."
    A: PERFETTO! I migliori clienti partono da zero. Ho protocolli specifici per principianti assoluti. Iniziamo gradualmente e costruiamo una base solida. La mia specialit√† √® proprio trasformare persone che non si sono mai allenate in atleti della loro vita quotidiana.
    
    Q: "Ho provato tutto, niente funziona per me..."
    A: Capisco la frustrazione. Il 90% dei fallimenti deriva da approcci generici o non sostenibili. Io lavoro diversamente: prima analizzo PERCH√â gli altri metodi non hanno funzionato, poi creo un piano che si adatta al TUO stile di vita, non viceversa.
    
    Q: "Non ho tempo, lavoro 12 ore al giorno..."
    A: I miei clienti pi√π occupati sono spesso quelli che ottengono i risultati migliori! Creo programmi da 20-30 minuti ultra-efficaci. L'efficienza batte sempre la quantit√†. E poi... chi ha tempo da perdere con allenamenti che non funzionano?
    
    Q: "Sono troppo vecchio per iniziare..."
    A: Il miglior momento per piantare un albero era 20 anni fa. Il secondo miglior momento √® OGGI. Ho clienti da 16 a 75 anni. L'et√† √® solo un numero quando hai il programma giusto.
    
    Q: "Costa troppo, non posso permettermelo..."
    A: Capisco. Ma facciamo un calcolo: quanto spendi in medicine, integratori che non servono, tentativi falliti, stress da malessere? Il personal training non √® un costo, √® un investimento nella tua salute. E ho soluzioni per tutti i budget: dalle miniclassi all'app online.
    
    Q: "Ho problemi fisici/infortuni..."
    A: Ancora meglio! Lavoro spesso con fisioterapisti. Il movimento corretto √® spesso la miglior medicina. Ovviamente tutto sotto supervisione medica quando necessario.
    
    Q: "Preferisco allenarmi da solo..."
    A: Ti capisco, molti la pensano cos√¨... finch√© non provano il personal training! Non √® che ti sto addosso a contare le ripetizioni. Ti insegno COME allenarti davvero, poi potrai essere autonomo. √à come imparare a guidare: serve un istruttore all'inizio.
    
    Q: "E se non ottengo risultati?"
    A: Domanda legittima. I risultati dipendono da: 1) Programma corretto (io) 2) Costanza (tu) 3) Alimentazione adeguata (insieme). Se fai la tua parte, i risultati arrivano. SEMPRE. Ho 12 anni di trasformazioni a dimostrarlo.
    
    Q: "Meglio palestra o personal trainer?"
    A: Dipende dai tuoi obiettivi. Palestra: buona per socializzare, costi bassi. Personal trainer: risultati garantiti, no perdite di tempo, apprendimento corretto. √à come la differenza tra studiare da autodidatta o avere un tutor privato.
    
    Q: "Quanto tempo per vedere risultati?"
    A: Prima settimana: pi√π energia. Secondo settimana: migliore umore. Primo mese: primi cambiamenti fisici visibili. Tre mesi: trasformazione evidente. Sei mesi: nuova persona. Ma gi√† dal primo allenamento ti senti diverso!
    
    === üìû CONTATTI E PRENOTAZIONI ===
    
    WhatsApp: 347 888 1515 (PREFERITO - risposta rapida)
    Email: andrea.padoan@gmail.com
    Sito Personal Training: https://www.personaltrainerverona.it
    Sito Trib√π Studio: https://www.tribustudio.it
    
    PRENOTAZIONE PRIMA SESSIONE:
    ‚Ä¢ Messaggio WhatsApp con: nome, obiettivo, disponibilit√† oraria
    ‚Ä¢ Sessione conoscitiva gratuita di 15 minuti
    ‚Ä¢ Prima sessione di prova: 40‚Ç¨ (detraibili dal pacchetto)
    ‚Ä¢ Possibilit√† di visitare lo studio prima di decidere
    
    === üéØ PERSONALIZZAZIONE MESSAGGI PER TIPOLOGIE CLIENTE ===
    
    CLIENTE PRINCIPIANTE:
    "Non preoccuparti di essere alle prime armi! I miei migliori clienti erano principianti assoluti. Partiamo dal tuo livello e costruiamo passo dopo passo. La cosa bella del fitness √® che ogni piccolo miglioramento √® una vittoria!"
    
    CLIENTE ESPERTO/DELUSO:
    "Capisco la frustrazione di non ottenere risultati nonostante l'impegno. Spesso il problema √® nella programmazione o nell'approccio. Analizziamo insieme cosa non ha funzionato e troviamo la strategia giusta per te."
    
    CLIENTE CON POCO TEMPO:
    "Perfetto! I miei protocolli pi√π efficaci sono spesso quelli pi√π brevi. 30 minuti con il programma giusto valgono pi√π di 2 ore casuali. Ottimizziamo ogni minuto del tuo tempo."
    
    CLIENTE BUDGET LIMITATO:
    "Ti capisco, l'investimento √® importante. Abbiamo diverse opzioni: dalle miniclassi a 15‚Ç¨ all'app online. L'importante √® iniziare con ci√≤ che √® sostenibile per te. I risultati giustificheranno l'investimento."
    
    CLIENTE MOTIVAZIONE BASSA:
    "La motivazione va e viene, ma le abitudini rimangono. Il mio lavoro √® aiutarti a creare un sistema che funzioni anche quando non hai voglia. Una volta che diventa automatico, non serve pi√π forza di volont√†."
    
    === üèÜ STORIE DI SUCCESSO (da usare come ispirazione) ===
    
    MARIA, 45 anni, manager:
    "In 6 mesi ha perso 15kg e ritrovato energia. Ora corre le maratone e ha cambiato lavoro per ridurre lo stress."
    
    LUCA, 30 anni, programmer:
    "Dal divano alla sua prima gara di triathlon in 1 anno. Ha risolto anche i problemi di postura dal lavoro al computer."
    
    GIULIA, 28 anni, neomamma:
    "Ha ritrovato la forma pre-gravidanza in 4 mesi e dice di sentirsi pi√π forte di prima."
    
    ANTONIO, 55 anni, imprenditore:
    "Ha trasformato completamente il suo corpo e il suo business. Maggiore energia = migliori decisioni."
    `;

    const advancedPrompt = `Sei Andrea Padoan, personal trainer e lifestyle coach di Verona.

    ${massiveKnowledgeBase}

    === üéØ ISTRUZIONI AVANZATE PER CONVERSAZIONI ===

    PERSONALIT√Ä:
    - Sei caloroso, genuino e motivante
    - Parli in prima persona con esperienza diretta
    - Eviti il gergo tecnico eccessivo (resta comprensibile)
    - Mostri passione autentica per la trasformazione delle persone
    - Sei diretto ma mai arrogante
    - Usi esempi concreti e storie reali

    STRATEGIA CONVERSAZIONALE:
    1. ASCOLTA: Fai domande per capire davvero la situazione
    2. EMPATIZZA: Riconosci le difficolt√† e frustrazioni
    3. EDUCA: Spiega il "perch√©" dietro i tuoi consigli
    4. ISPIRA: Condividi visioni positive del futuro
    5. GUIDA: Proponi azioni concrete e prossimi passi

    QUANDO PARLARE DI PREZZI:
    - Non evitare l'argomento, ma contestualizza il valore
    - Usa il principio "investimento vs costo"
    - Presenta sempre 2-3 opzioni
    - Sottolinea i benefici a lungo termine

    GESTIONE OBIEZIONI:
    - Riconosci sempre la validit√† della preoccupazione
    - Condividi esperienze di altri clienti simili
    - Proponi alternative o compromessi
    - Non essere mai insistente o aggressivo

    CALL TO ACTION:
    - Sempre presente ma mai pressante
    - Offri sempre un "passo successivo" facile
    - Usa il WhatsApp come contatto preferito
    - Proponi la sessione conoscitiva gratuita

    TONO E STILE:
    - Usa "tu" informale
    - Inserisci qualche emoji appropriata (üí™ üéØ üòä)
    - Frasi non troppo lunghe
    - Linguaggio colloquiale ma professionale

    Messaggio utente: "${message.trim()}"

    Rispondi come Andrea Padoan seguendo le istruzioni avanzate:`;
    
    try {
        console.log('üîÑ Calling Claude API with enhanced prompt...');
        
        // Chiama Claude API con modello aggiornato
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': claudeApiKey,
                'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
                model: 'claude-3-5-sonnet-20240620',
                max_tokens: 500, // Aumentato per risposte pi√π complete
                messages: [{ role: 'user', content: advancedPrompt }]
            })
        });
        
        console.log('üì° Claude API response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Claude API Error:', response.status, errorText);
            throw new Error(`Claude API Error: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Claude API success with enhanced knowledge');
        
        if (!data.content || !data.content[0] || !data.content[0].text) {
            console.error('‚ùå Invalid Claude API response format:', data);
            throw new Error('Invalid response format from Claude API');
        }
        
        const botResponse = data.content[0].text;
        console.log('üí¨ Enhanced bot response generated, length:', botResponse.length);
        
        // Enhanced Airtable logging with more intelligence
        enhancedAirtableLogging(message.trim(), botResponse)
            .then(() => console.log('‚úÖ Enhanced Airtable logging completed'))
            .catch(err => console.error('‚ùå Airtable logging failed:', err));
        
        // Return successful response
        res.status(200).json({ response: botResponse });
        
    } catch (error) {
        console.error('‚ùå Handler Error:', error);
        
        // Return user-friendly error message
        res.status(500).json({ 
            error: 'Mi dispiace, ho avuto un problema tecnico. Contattami su WhatsApp al 347 888 1515!' 
        });
    }
}

// üìä ENHANCED AIRTABLE LOGGING con AI pi√π intelligente
async function enhancedAirtableLogging(userMessage, botResponse) {
    const webhookUrl = 'https://hooks.airtable.com/workflows/v1/genericWebhook/applozDwnDZOgPvsg/wflXjsQEowx2dmnN8/wtrzKiazR0Tt8171P';
    
    const leadScore = advancedLeadScore(userMessage, botResponse);
    const interestArea = intelligentInterestDetection(userMessage);
    const sessionId = generateSessionId();
    const conversationStage = detectConversationStage(userMessage);
    const urgencyLevel = detectUrgency(userMessage);
    
    const payload = {
        User_Message: userMessage,
        Bot_Response: botResponse,
        Lead_Score: leadScore,
        Interest_Area: interestArea,
        Session_ID: sessionId,
        Conversation_Stage: conversationStage,
        Urgency_Level: urgencyLevel,
        Message_Length: userMessage.length,
        Response_Length: botResponse.length,
        User_Agent: 'Vercel-API-Enhanced'
    };
    
    try {
        console.log('üìä Enhanced logging to Airtable...', {
            leadScore,
            interestArea,
            conversationStage,
            urgencyLevel,
            sessionId
        });
        
        const response = await fetch(webhookUrl, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        if (response.ok) {
            console.log('‚úÖ Enhanced conversation logged to Airtable successfully');
        } else {
            const errorText = await response.text();
            console.error('‚ùå Failed to log to Airtable:', response.status, errorText);
        }
    } catch (error) {
        console.error('‚ùå Airtable logging error:', error);
    }
}

// üéØ ADVANCED LEAD SCORING con logica pi√π sofisticata
function advancedLeadScore(message, botResponse) {
    let score = 3; // Base score ridotto
    const lower = message.toLowerCase();
    
    // üî• HIGH INTENT SIGNALS (3-4 points each)
    if (lower.includes('voglio iniziare') || lower.includes('come si fa')) score += 4;
    if (lower.includes('quanto costa') || lower.includes('prezzi') || lower.includes('tariffe')) score += 4;
    if (lower.includes('prenotare') || lower.includes('appuntamento')) score += 5;
    if (lower.includes('quando possiamo') || lower.includes('disponibilit√†')) score += 4;
    if (lower.includes('urgente') || lower.includes('subito') || lower.includes('prima possibile')) score += 4;
    
    // üí∞ BUYING SIGNALS (2-3 points each)
    if (lower.includes('investimento') || lower.includes('budget')) score += 3;
    if (lower.includes('pacchetto') || lower.includes('abbonamento')) score += 3;
    if (lower.includes('prova') || lower.includes('test')) score += 2;
    
    // üéØ SPECIFIC NEEDS (2-3 points each)
    if (lower.includes('dimagrire') || lower.includes('perdere peso')) score += 3;
    if (lower.includes('tonificare') || lower.includes('muscoli')) score += 3;
    if (lower.includes('risultati') || lower.includes('obiettivi')) score += 2;
    if (lower.includes('trasformazione') || lower.includes('cambiare')) score += 3;
    
    // üö® PAIN POINTS (2-3 points each)
    if (lower.includes('non riesco') || lower.includes('fallito') || lower.includes('provato tutto')) score += 3;
    if (lower.includes('frustrato') || lower.includes('demotivato')) score += 2;
    if (lower.includes('problema') || lower.includes('difficolt√†')) score += 2;
    
    // üìû CONTACT READINESS (3-5 points each)
    if (lower.includes('numero') || lower.includes('telefono') || lower.includes('chiamare')) score += 4;
    if (lower.includes('whatsapp') || lower.includes('messaggio')) score += 3;
    if (lower.includes('incontrarci') || lower.includes('vederci')) score += 5;
    
    // üèÉ‚Äç‚ôÇÔ∏è SERVICE INTEREST (1-2 points each)
    if (lower.includes('personal training') || lower.includes('personal trainer')) score += 2;
    if (lower.includes('studio') || lower.includes('trib√π')) score += 2;
    if (lower.includes('online') || lower.includes('app')) score += 1;
    if (lower.includes('coppia') || lower.includes('insieme')) score += 2;
    
    // ‚è∞ TIME AVAILABILITY (1-2 points each)
    if (lower.includes('tempo') && (lower.includes('poco') || lower.includes('limitato'))) score += 1;
    if (lower.includes('mattina') || lower.includes('sera') || lower.includes('weekend')) score += 1;
    
    // üí¨ MESSAGE QUALITY BONUS
    if (message.length > 100) score += 1; // Longer messages show more interest
    if (message.split(' ').length > 20) score += 1; // Detailed messages
    
    // ü§ù RELATIONSHIP BUILDING
    if (lower.includes('grazie') || lower.includes('complimenti')) score += 1;
    if (lower.includes('esperienza') || lower.includes('professionale')) score += 1;
    
    return Math.min(score, 10); // Max score 10
}

// üß† INTELLIGENT INTEREST DETECTION con pi√π categorie
function intelligentInterestDetection(message) {
    const lower = message.toLowerCase();
    let scores = {
        fitness: 0,
        nutrition: 0,
        business: 0,
        coaching: 0,
        online: 0,
        studio: 0,
        posturale: 0
    };
    
    // FITNESS KEYWORDS
    const fitnessKeywords = ['personal', 'allenamento', 'fitness', 'palestra', 'muscoli', 'forma', 'peso', 
                           'dimagrire', 'tonificare', 'esercizi', 'workout', 'training'];
    fitnessKeywords.forEach(keyword => {
        if (lower.includes(keyword)) scores.fitness += 1;
    });
    
    // NUTRITION KEYWORDS
    const nutritionKeywords = ['dieta', 'alimentazione', 'mangiare', 'pasti', 'nutrizione', 'meal', 
                              'cibo', 'calorie', 'mealprep', 'ricette'];
    nutritionKeywords.forEach(keyword => {
        if (lower.includes(keyword)) scores.nutrition += 1;
    });
    
    // BUSINESS KEYWORDS
    const businessKeywords = ['business', 'startup', 'impresa', 'soldi', 'guadagno', 'upstart', 
                             'idea', 'progetto', 'imprenditore'];
    businessKeywords.forEach(keyword => {
        if (lower.includes(keyword)) scores.business += 1;
    });
    
    // COACHING KEYWORDS
    const coachingKeywords = ['mindset', 'motivazione', 'coach', 'lifestyle', 'mente', 'psicologia', 
                             'abitudini', 'cambiare', 'trasformazione'];
    coachingKeywords.forEach(keyword => {
        if (lower.includes(keyword)) scores.coaching += 1;
    });
    
    // ONLINE KEYWORDS
    const onlineKeywords = ['online', 'distanza', 'app', 'torno in forma', 'remoto', 'video'];
    onlineKeywords.forEach(keyword => {
        if (lower.includes(keyword)) scores.online += 1;
    });
    
    // STUDIO KEYWORDS
    const studioKeywords = ['studio', 'trib√π', 'verona', 'coppia', 'miniclass', 'gruppo'];
    studioKeywords.forEach(keyword => {
        if (lower.includes(keyword)) scores.studio += 1;
    });
    
    // POSTURALE KEYWORDS
    const posturaleKeywords = ['postura', 'mal di schiena', 'dolore', 'cervicale', 'riabilitazione'];
    posturaleKeywords.forEach(keyword => {
        if (lower.includes(keyword)) scores.posturale += 1;
    });
    
    // Return the category with highest score
    const maxScore = Math.max(...Object.values(scores));
    const topCategory = Object.keys(scores).find(key => scores[key] === maxScore);
    
    return maxScore > 0 ? topCategory : 'general';
}

// üé≠ CONVERSATION STAGE DETECTION
function detectConversationStage(message) {
    const lower = message.toLowerCase();
    
    // INITIAL INQUIRY
    if (lower.includes('ciao') || lower.includes('salve') || lower.includes('buongiorno') || 
        lower.includes('informazioni') || lower.includes('sapere') || lower.includes('vorrei')) {
        return 'initial_inquiry';
    }
    
    // PRICE INQUIRY
    if (lower.includes('costo') || lower.includes('prezzo') || lower.includes('quanto') || 
        lower.includes('tariffe') || lower.includes('budget')) {
        return 'price_inquiry';
    }
    
    // BOOKING INTENT
    if (lower.includes('prenotare') || lower.includes('appuntamento') || lower.includes('quando') || 
        lower.includes('disponibile') || lower.includes('orari')) {
        return 'booking_intent';
    }
    
    // OBJECTION HANDLING
    if (lower.includes('ma') || lower.includes('per√≤') || lower.includes('non so') || 
        lower.includes('dubbio') || lower.includes('pensare')) {
        return 'objection_handling';
    }
    
    // READY TO BUY
    if (lower.includes('va bene') || lower.includes('perfetto') || lower.includes('iniziamo') || 
        lower.includes('procediamo') || lower.includes('contatto')) {
        return 'ready_to_buy';
    }
    
    return 'exploration';
}

// ‚ö° URGENCY LEVEL DETECTION
function detectUrgency(message) {
    const lower = message.toLowerCase();
    
    if (lower.includes('urgente') || lower.includes('subito') || lower.includes('prima possibile') || 
        lower.includes('immediato')) {
        return 'high';
    }
    
    if (lower.includes('presto') || lower.includes('velocemente') || lower.includes('entro') || 
        lower.includes('questa settimana')) {
        return 'medium';
    }
    
    return 'low';
}

function generateSessionId() {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 8);
    return `sess_${timestamp}_${random}`;
}